# Payment Log Database Guide

## Overview

This document explains the payment logging system for tracking all SSLCOMMERZ (and other online payment) transactions in your Laravel application.

## Database Schema

### Table: `payment_logs`

| Column | Type | Description |
|--------|------|-------------|
| `id` | bigint | Primary key |
| `order_id` | bigint | Related order ID (foreign key to orders) |
| `trx_id` | string | Internal transaction ID (generated by your app) |
| `gateway_tran_id` | string | Payment gateway transaction ID (e.g., SSLCOMMERZ tran_id) |
| `order_code` | string | Order code (e.g., #50009) |
| `gateway` | enum | Payment gateway: sslcommerz, paypal, stripe, bkash, nagad, rocket, kkiapay, other |
| `event_type` | enum | Type of event (see Event Types below) |
| `payment_status` | enum | Status: pending, processing, completed, failed, cancelled, refunded |
| `amount` | decimal(10,2) | Payment amount |
| `currency` | string(10) | Currency code (e.g., BDT, USD) |
| `val_id` | string | Validation ID from gateway |
| `card_type` | string | Card/wallet type used |
| `bank_tran_id` | string | Bank transaction ID |
| `status` | string | Gateway response status |
| `request_data` | json | Full request data from gateway |
| `response_data` | json | Full response data from gateway |
| `validation_data` | json | Validation response data |
| `error_message` | text | Error message if any |
| `error_code` | string | Error code from gateway |
| `ip_address` | string | Client IP address |
| `user_agent` | text | Client user agent |
| `environment` | enum | Payment environment: sandbox, production |
| `initiated_at` | timestamp | When payment was initiated |
| `gateway_responded_at` | timestamp | When gateway responded |
| `completed_at` | timestamp | When payment was completed |
| `notes` | text | Additional notes or comments |
| `created_at` | timestamp | Record creation time |
| `updated_at` | timestamp | Record update time |
| `deleted_at` | timestamp | Soft delete timestamp |

## Event Types

| Event Type | Description |
|------------|-------------|
| `initiation` | Payment initiated by user |
| `redirect` | User redirected to gateway |
| `success_callback` | Success callback received from gateway |
| `fail_callback` | Failure callback received from gateway |
| `cancel_callback` | User cancelled at gateway |
| `ipn_received` | IPN received from gateway (server-to-server) |
| `ipn_processed` | IPN processed successfully |
| `validation_success` | Transaction validated successfully |
| `validation_failed` | Transaction validation failed |
| `order_completed` | Order completed successfully |
| `order_failed` | Order failed |
| `duplicate_prevented` | Duplicate payment prevented |
| `error` | Any error occurred |

## Payment Status Values

| Status | Description |
|--------|-------------|
| `pending` | Payment initiated, waiting for completion |
| `processing` | Payment is being processed |
| `completed` | Payment completed successfully |
| `failed` | Payment failed |
| `cancelled` | Payment cancelled by user |
| `refunded` | Payment refunded |

## SQL Queries for Payment Logs

### 1. View All Payment Logs

```sql
SELECT * FROM payment_logs ORDER BY created_at DESC;
```

### 2. View Logs by Transaction ID (Internal)

```sql
SELECT
    id,
    order_id,
    trx_id,
    gateway_tran_id,
    gateway,
    event_type,
    payment_status,
    amount,
    currency,
    error_message,
    created_at
FROM payment_logs
WHERE trx_id = 'your_internal_trx_id'
ORDER BY created_at ASC;
```

### 3. View Logs by Gateway Transaction ID

```sql
SELECT
    id,
    order_id,
    trx_id,
    gateway_tran_id,
    gateway,
    event_type,
    payment_status,
    amount,
    currency,
    status,
    error_message,
    created_at
FROM payment_logs
WHERE gateway_tran_id = 'sslcommerz_tran_id'
ORDER BY created_at ASC;
```

### 4. View Logs by Order Code

```sql
SELECT
    id,
    order_id,
    trx_id,
    gateway_tran_id,
    order_code,
    gateway,
    event_type,
    payment_status,
    amount,
    currency,
    created_at
FROM payment_logs
WHERE order_code = '#50009'
ORDER BY created_at ASC;
```

### 5. View Today's Payment Logs

```sql
SELECT
    id,
    order_id,
    order_code,
    gateway,
    event_type,
    payment_status,
    amount,
    currency,
    created_at
FROM payment_logs
WHERE DATE(created_at) = CURDATE()
ORDER BY created_at DESC;
```

### 6. View Failed Payments

```sql
SELECT
    id,
    order_id,
    trx_id,
    gateway_tran_id,
    order_code,
    gateway,
    event_type,
    payment_status,
    amount,
    error_message,
    error_code,
    created_at
FROM payment_logs
WHERE payment_status = 'failed'
ORDER BY created_at DESC;
```

### 7. View Completed Payments

```sql
SELECT
    id,
    order_id,
    order_code,
    gateway,
    event_type,
    payment_status,
    amount,
    currency,
    card_type,
    completed_at,
    created_at
FROM payment_logs
WHERE payment_status = 'completed'
ORDER BY created_at DESC;
```

### 8. View Logs by Gateway (e.g., SSLCOMMERZ)

```sql
SELECT
    id,
    order_id,
    trx_id,
    gateway_tran_id,
    order_code,
    event_type,
    payment_status,
    amount,
    currency,
    status,
    created_at
FROM payment_logs
WHERE gateway = 'sslcommerz'
ORDER BY created_at DESC;
```

### 9. View IPN Logs Only

```sql
SELECT
    id,
    order_id,
    trx_id,
    gateway_tran_id,
    event_type,
    payment_status,
    amount,
    status,
    request_data,
    response_data,
    created_at
FROM payment_logs
WHERE event_type IN ('ipn_received', 'ipn_processed')
ORDER BY created_at DESC;
```

### 10. Payment Statistics Summary

```sql
SELECT
    gateway,
    payment_status,
    COUNT(*) as count,
    SUM(amount) as total_amount
FROM payment_logs
WHERE event_type IN ('order_completed', 'order_failed')
GROUP BY gateway, payment_status
ORDER BY gateway, payment_status;
```

### 11. View Full Transaction Timeline

```sql
SELECT
    id,
    order_id,
    trx_id,
    gateway_tran_id,
    order_code,
    event_type,
    payment_status,
    amount,
    currency,
    error_message,
    created_at
FROM payment_logs
WHERE trx_id = 'your_trx_id' OR gateway_tran_id = 'gateway_trx_id'
ORDER BY created_at ASC;
```

### 12. View Duplicate Payment Attempts

```sql
SELECT
    gateway_tran_id,
    COUNT(*) as attempt_count,
    GROUP_CONCAT(DISTINCT event_type) as events,
    GROUP_CONCAT(DISTINCT payment_status) as statuses,
    MIN(created_at) as first_attempt,
    MAX(created_at) as last_attempt
FROM payment_logs
GROUP BY gateway_tran_id
HAVING attempt_count > 1
ORDER BY attempt_count DESC;
```

### 13. View Errors by Type

```sql
SELECT
    error_code,
    error_message,
    COUNT(*) as occurrence_count,
    gateway,
    event_type,
    created_at
FROM payment_logs
WHERE error_message IS NOT NULL
GROUP BY error_code, error_message, gateway, event_type
ORDER BY occurrence_count DESC;
```

### 14. View Environment-Specific Logs (Sandbox vs Production)

```sql
SELECT
    gateway,
    environment,
    event_type,
    payment_status,
    COUNT(*) as count,
    SUM(amount) as total_amount
FROM payment_logs
GROUP BY gateway, environment, event_type, payment_status
ORDER BY gateway, environment, event_type;
```

### 15. Search Logs by IP Address

```sql
SELECT
    id,
    order_id,
    trx_id,
    gateway_tran_id,
    gateway,
    event_type,
    payment_status,
    amount,
    ip_address,
    created_at
FROM payment_logs
WHERE ip_address = '192.168.1.1'
ORDER BY created_at DESC;
```

## Laravel Eloquent Queries

### Using the PaymentLog Model

```php
use App\Models\PaymentLog;

// Get all logs for a transaction
$logs = PaymentLog::byTrxId('trx_id')->get();

// Get all logs for a gateway transaction
$logs = PaymentLog::byGatewayTranId('gateway_tran_id')->get();

// Get completed payments
$completed = PaymentLog::completed()->get();

// Get failed payments
$failed = PaymentLog::failed()->get();

// Get today's logs
$today = PaymentLog::today()->get();

// Get logs by gateway
$sslcommerz = PaymentLog::byGateway('sslcommerz')->get();

// Get logs by event type
$ipnLogs = PaymentLog::byEventType('ipn_received')->get();
```

### Using the PaymentLogService

```php
use App\Services\PaymentLogService;

$paymentLog = app(PaymentLogService::class);

// Log initiation
$paymentLog->logInitiation([
    'order_id' => 123,
    'trx_id' => 'TRX123',
    'gateway' => 'sslcommerz',
    'amount' => 100.00,
    'currency' => 'BDT',
    'environment' => 'production',
]);

// Log success
$paymentLog->logSuccessCallback([
    'order_id' => 123,
    'trx_id' => 'TRX123',
    'gateway_tran_id' => 'SSL123',
    'gateway' => 'sslcommerz',
    'amount' => 100.00,
    'currency' => 'BDT',
    'request_data' => $request->all(),
]);

// Get logs for a transaction
$logs = $paymentLog->getLogsByTrxId('TRX123');

// Get statistics
$stats = $paymentLog->getStatistics(
    now()->subDays(30),
    now(),
    'sslcommerz'
);
```

## Running the Migration

```bash
php artisan migrate
```

This will create the `payment_logs` table with all necessary indexes.

## Files Created

1. **Migration**: `database/migrations/2026_02_02_000002_create_payment_logs_table.php`
2. **Model**: `app/Models/PaymentLog.php`
3. **Service**: `app/Services/PaymentLogService.php`
4. **Controller Update**: `app/Http/Controllers/SslCommerzPaymentController.php` (with logging)

## Usage in Controllers

The `SslCommerzPaymentController` has been updated to include the `PaymentLogService`. You can now log payment events at various stages:

```php
// Log payment initiation
$this->paymentLog->logInitiation([
    'order_id' => $order->id,
    'trx_id' => $trx_id,
    'gateway' => 'sslcommerz',
    'amount' => $amount,
    'currency' => 'BDT',
    'environment' => $is_sandbox ? 'sandbox' : 'production',
]);

// Log redirect
$this->paymentLog->logRedirect([
    'order_id' => $order->id,
    'trx_id' => $trx_id,
    'gateway_tran_id' => $sslcommerz_tran_id,
    'gateway' => 'sslcommerz',
]);

// Log success callback
$this->paymentLog->logSuccessCallback([
    'order_id' => $order->id,
    'trx_id' => $trx_id,
    'gateway_tran_id' => $tran_id,
    'gateway' => 'sslcommerz',
    'amount' => $amount,
    'currency' => $currency,
    'val_id' => $request->input('val_id'),
    'card_type' => $request->input('card_type'),
    'request_data' => $request->all(),
]);

// Log validation success
$this->paymentLog->logValidationSuccess([
    'order_id' => $order->id,
    'trx_id' => $trx_id,
    'gateway_tran_id' => $tran_id,
    'gateway' => 'sslcommerz',
    'validation_data' => $validationResult,
]);

// Log order completed
$this->paymentLog->logOrderCompleted([
    'order_id' => $order->id,
    'trx_id' => $trx_id,
    'gateway_tran_id' => $tran_id,
    'gateway' => 'sslcommerz',
    'amount' => $amount,
    'currency' => 'BDT',
]);
```

## Troubleshooting

### Check if a transaction was logged

```sql
SELECT * FROM payment_logs WHERE trx_id = 'your_trx_id';
```

### Check for duplicate transactions

```sql
SELECT gateway_tran_id, COUNT(*) FROM payment_logs
GROUP BY gateway_tran_id HAVING COUNT(*) > 1;
```

### View error details

```sql
SELECT * FROM payment_logs
WHERE payment_status = 'failed'
AND error_message IS NOT NULL
ORDER BY created_at DESC
LIMIT 50;
```

## Maintenance

### Clean old logs (optional)

```php
use App\Services\PaymentLogService;

$paymentLog = app(PaymentLogService::class);

// Delete logs older than 90 days
$deleted = $paymentLog->cleanOldLogs(90);
```

## Security Notes

1. The `request_data`, `response_data`, and `validation_data` columns contain JSON data that may include sensitive information.
2. Ensure proper access controls are in place when viewing payment logs.
3. Consider masking sensitive data like card numbers in production logs.
4. The `ip_address` field can help track fraudulent payment attempts.